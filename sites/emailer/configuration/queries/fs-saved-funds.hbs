{{#withExtend this siteConfig=templateMetaData.config.metaData.siteConfiguration}}
  {{#>queries_fund_wrapper this}}
    {{#json key="bool"}}
      {{#json key="should" type="array"}}
        {{#json}}
          {{#json key="bool"}}
            {{#json key="filter" type="array"}}
              {{#ifAny @root.request.params.query.lastsent templateMetaData.lastSent}}
                {{>queries_date_range field="date_last_important_activity" gte=(momentFormat (moment (default @root.request.params.query.lastsent templateMetaData.lastSent) "") "x")}}
              {{else}}
                {{>queries_date_range field="date_last_important_activity" gte="now-1w/d"}}
              {{/ifAny}},
              {{>queries_term field="fund_status" term="Open"}}
            {{/json}}
          {{/json}}
        {{/json}},
        {{#json}}
          {{#json key="bool"}}
            {{#json key="filter" type="array"}}
              {{>queries_date_range field="date_reopens" gte="now+3M-3d/d" lte="now+3M+3d/d"}},
              {{>queries_term field="fund_status" term="Currently Closed"}}
            {{/json}}
          {{/json}}
        {{/json}}
      {{/json}},
      {{{json key="minimum_should_match" value=1}}}
    {{/json}},
    {{#json key="bool"}}
      {{#json key="should" type="array"}}
        {{#each (split templateMetaData.querystrings "&&")}}
          {{#json}}
            {{#json key="ids"}}
              {{{json key="type" value="fundingscotland-fund"}}},
              {{{json key="values" value=(arrayify (getProperty (querystring this) "id"))}}}
            {{/json}}
          {{/json}},
        {{/each}}
      {{/json}}
    {{/json}}
  {{/queries_fund_wrapper}}
{{/withExtend}}