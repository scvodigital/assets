{{#json type="array"}}
  {{#if @root.data.search_data}}
    {{#each @root.data.notifications.subscriptions.[1]}}
      {{#withExtend this
        campaignConfig=(getProperty @root.context.metaData.campaignConfig campaign)
        recipientId=(slugify (concat campaign " " email))
        searchData=(getProperty @root.data.search_data (concat (slugify (concat campaign " " email)) ".hits.hits"))
      }}
        {{#>should_send
          sendIfEmpty=campaignConfig.sendIfEmpty
          searchData=searchData
          importantType=(default campaignConfig.importantType null)
        }}
          {{#json}}
            {{{json key="from" value=campaignConfig.from}}},
            {{{json key="h:sender" value=campaignConfig.from}}},
            {{{json key="to" value=(default testEmail email)}}},
            {{{json key="o:tag" value=(if testEmail (concat "test-" campaign) else=campaign)}}},
            {{{json key="o:tracking" value=true}}},
            {{#if @root.request.params.query.dontSend}}
              {{{json key="o:testmode" value=true}}},
            {{/if}}
            {{{json key="tag" value=campaign}}},
            {{{json key="if" value=campaign}}},
            {{{json key="connectionName" value=campaignConfig.mailgunConnection}}},
            {{#json key="subject" type="string"}}
              {{~>
                (getProperty @root.context.metaData.campaignConfig (concat campaign '.subjectPartial'))
                subscription=this
                searchData=(getProperty @root.data.search_data (concat (slugify (concat campaign " " email))))
                campaignConfig=(getProperty @root.context.metaData.campaignConfig campaign)
              ~}}
            {{/json}},
            {{#json key="html" type="string"}}
              {{~>
                (getProperty @root.context.metaData.campaignConfig (concat campaign '.bodyPartial'))
                subscription=this
                searchData=(getProperty @root.data.search_data (concat (slugify (concat campaign " " email))))
                campaignConfig=(getProperty @root.context.metaData.campaignConfig campaign)
              ~}}
            {{/json}}
          {{/json}}
        {{/should_send}}
      {{/withExtend}}
    {{/each}}
  {{/if}}
{{/json}}