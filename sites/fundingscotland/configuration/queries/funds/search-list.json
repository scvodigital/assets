{
  "size": 10,
  "from": {{#if @root.data.auth}}{{multiply (subtract (default (if (compare request.params.query.page ">" 5) 5 else=request.params.query.page) 1) 1) 10}}{{else}}0{{/if}},
  "_source": [
    "Id",
    "slug",
    "title",
    "text_bag_boost",
    "fund_status",
    "fund_status_slug",
    "date_reopens",
    "for_charities_only",
    "activities",
    "activities_slugs",
    "beneficiaries",
    "beneficiaries_slugs",
    "region_group",
    "region_group_slug",
    "description",
    "source_of_fund",
    "type_of_cost",
    "type_of_funding",
    "funder_organisation.slug",
    "funder_organisation.name",
    "funder_organisation.has_logo",
    "funder_organisation.logo_url",
    "rendered.fundingscotland_rss"
  ],
  "query": {{#>queries_fund_common}}
    "bool": {
      "filter": [
        {{>queries_fund_search_filters @root.request.params.query}}
      ],
      "must": [
        {{>queries_fund_search_must @root.request.params.query}}
      ],
      "should": [
        {{>queries_term field="fund_status_slug" term="open"}},
        {{#if (contains @root.request.params.query.miscellaneous "show-opening-soon-funds")}}
        {
          "bool": {
            "filter": [
              {{>queries_term field="fund_status_slug" term="currently-closed"}},
              {{>queries_date_range field="date_reopens" lte="now+7d/d" gte="now/d"}}
            ]
          }
        },
        {{/if}}
        {{#if (contains @root.request.params.query.miscellaneous "show-closed-funds")}}
          {{>queries_term field="fund_status_slug" term="currently-closed"}},
        {{/if}}
        {{>queries_do_nothing}}
      ],
      "minimum_should_match": 2
    }
  {{/queries_fund_common}},
  "sort": [
    {{#if @root.request.params.query.sort ~}}
    {{#compare @root.request.params.query.sort "===" "max_funded_asc" ~}}
    {
      "maximum_award_size": "asc"
    }
    {{else}}
    {{#compare @root.request.params.query.sort "===" "max_funded_desc" ~}}
    {
      "maximum_award_size": "desc"
    }
    {{else}}
    {{#compare @root.request.params.query.sort "===" "deadline_date_asc" ~}}
    {
      "next_deadline": "asc"
    }
    {{else}}
    {{#compare @root.request.params.query.sort "===" "deadline_date_desc" ~}}
    {
      "next_deadline": "desc"
    }
    {{else}}
    {{#compare @root.request.params.query.sort "===" "alphabetical_asc" ~}}
    {
      "name": "asc"
    }
    {{else}}
    {{#compare @root.request.params.query.sort "===" "alphabetical_desc" ~}}
    {
      "name": "desc"
    }
    {{else}}
    {{#compare @root.request.params.query.sort "===" "date_last_reviewed" ~}}
    {
      "date_last_important_activity": "asc"
    }
    {{else}}
    {{#compare @root.request.params.query.sort "===" "relevance" ~}}
    "_score"
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{else}}
    "_score"
    {{/if ~}}
  ]
}